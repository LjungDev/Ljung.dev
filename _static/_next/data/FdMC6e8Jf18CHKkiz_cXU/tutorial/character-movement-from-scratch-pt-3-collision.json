{"pageProps":{"siteMetainfo":{"headerTitle":"Ljung","headerSubtitle":".dev","pageTitlePrefix":"Ljung | "},"_site":{"globalSeo":{"siteName":"Ljung","fallbackSeo":{"title":"Ljung | Game Dev","description":"Indie Game Developer from Sweden ðŸŽ®"}}},"post":{"title":"Character Movement from Scratch pt 3: Collision","description":"In this part we will make sure our character can't walk through walls.","seriesPrevious":{"slug":"character-movement-from-scratch-pt-2-basic-movement","seriesTitle":"pt 2: Basic Movement"},"seriesNext":{"slug":"character-movement-from-scratch-pt-4-gravity","seriesTitle":"pt 4: Gravity"},"content":{"value":{"schema":"dast","document":{"type":"root","children":[{"type":"blockquote","children":[{"type":"paragraph","children":[{"type":"span","value":"A project using this tutorial series is "},{"url":"https://github.com/LjungDev/Cactus","meta":[{"id":"target","value":"_blank"}],"type":"link","children":[{"type":"span","value":"tracked on GitHub"}]},{"type":"span","value":". The revision after this part is "},{"url":"https://github.com/LjungDev/Cactus/commit/39e74196af789d7da1b418fd0c9fc081720a554e","meta":[{"id":"target","value":"_blank"}],"type":"link","children":[{"type":"span","value":"39e7419"}]},{"type":"span","value":"."}]}]},{"type":"paragraph","children":[{"type":"span","value":"Hej!"}]},{"type":"paragraph","children":[{"type":"span","value":"In this part we will look at basic collision handling related to movement and make sure that our character doesn't go through walls anymore."}]},{"type":"paragraph","children":[{"type":"span","value":"It is actually fairly easy to implement as Unreal does all the heavy lifting of doing low-level collision checking, however we need to make sure that \"colliding\" means to prevent walking through walls, and also try to slide along them instead. Luckily there is a function built into "},{"type":"span","marks":["code"],"value":"UMovementComponent"},{"type":"span","value":" called "},{"type":"span","marks":["code"],"value":"SlideALongSurface"},{"type":"span","value":" that helps with that."}]},{"type":"paragraph","children":[{"type":"span","value":"The steps we need to take are:"}]},{"type":"list","style":"numbered","children":[{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"span","value":"Set character collision profile to "},{"type":"span","marks":["code"],"value":"Pawn"},{"type":"span","value":"."}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"span","value":"Change "},{"type":"span","marks":["code"],"value":"MoveUpdatedComponent"},{"type":"span","value":" to "},{"type":"span","marks":["code"],"value":"SafeMoveUpdatedComponent."}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"span","value":"Check for any valid hits after moving."}]}]},{"type":"listItem","children":[{"type":"paragraph","children":[{"type":"span","value":"Call HandleImpact and SlideAlongSurface accordingly."}]}]}]},{"type":"heading","level":1,"children":[{"type":"span","value":"Collision Profile"}]},{"type":"paragraph","children":[{"type":"span","value":"First things first we need to set the collision profile of our character to "},{"type":"span","marks":["code"],"value":"Pawn"},{"type":"span","value":" (or something else that might be appropriate for your project). By default it is set to "},{"type":"span","marks":["code"],"value":"OverlapAllDynamic"},{"type":"span","value":" which won't trigger any blocking hits. In your equivalent of "},{"type":"span","marks":["code"],"value":"BP_CactusPlayerPawn"},{"type":"span","value":", on the capsule component set the collision preset:"}]},{"item":"55423363","type":"block"},{"type":"heading","level":1,"children":[{"type":"span","value":"Movement Code"}]},{"type":"heading","level":2,"children":[{"type":"span","value":"SafeMoveUpdatedComponent"}]},{"type":"paragraph","children":[{"type":"span","value":"First we are going to change "},{"type":"span","marks":["code"],"value":"MoveUpdatedComponent"},{"type":"span","value":" to "},{"type":"span","marks":["code"],"value":"SafeMoveUpdatedComponent"},{"type":"span","value":". This is strictly not necessary for our code to work, however the difference is that the safe version automatically resolves initial penetrations, if we somehow start or end-up inside a wall. To facilitate this the safe version requires an additional "},{"type":"span","marks":["code"],"value":"FHitResult"},{"type":"span","value":" parameter (optional on the non-safe variant). "}]},{"type":"paragraph","children":[{"type":"span","value":"Replace our call to "},{"type":"span","marks":["code"],"value":"MoveUpdatedComponent(...)"},{"type":"span","value":" with:"}]},{"code":"FHitResult Hit;\nSafeMoveUpdatedComponent(Velocity, Rotation, true, Hit);","type":"code","language":"cpp"},{"type":"paragraph","children":[{"type":"span","value":"Notice that we also set the "},{"type":"span","marks":["code"],"value":"bSweep"},{"type":"span","value":" parameter to "},{"type":"span","marks":["code"],"value":"true"},{"type":"span","value":". This is what enables collision checking internally."}]},{"type":"heading","level":1,"children":[{"type":"span","value":"SlideAlongSurface"}]},{"type":"paragraph","children":[{"type":"span","value":"If you hit play now and try moving around you will notice that we won't go through walls anymore. However, unless we are moving directly away from a wall we instead stick to it!"}]},{"item":"55423364","type":"block"},{"type":"paragraph","children":[{"type":"span","value":"This is because we have yet to handle what happens when we collide. "},{"type":"span","marks":["code"],"value":"SafeMoveUpdatedComponent"},{"type":"span","value":" automatically stops the movement but we need to slide along the surface as well. Luckily it's very simple; we only need to add the following snippet directly after the movement call:"}]},{"code":"if (Hit.IsValidBlockingHit())\n{\n   HandleImpact(Hit, DeltaTime, Velocity);\n   SlideAlongSurface(Velocity, 1.0f - Hit.Time, Hit.Normal, Hit, true);\n}","type":"code","language":"cpp"},{"type":"paragraph","children":[{"type":"span","marks":["code"],"value":"HandleImpact"},{"type":"span","value":" is a helper to catch and propagate an impact throughout the movement component, however the base implementation is empty so in our case it is not strictly needed, but it's still good practice to include."}]},{"type":"paragraph","children":[{"type":"span","marks":["code"],"value":"SlideAlongSurface"},{"type":"span","value":" is the main part and it simply computes and moves the component along a projected vector based on the normal (angle) and other parameters we give it. Internally it calls "},{"type":"span","marks":["code"],"value":"SafeMoveUpdatedComponent"},{"type":"span","value":" and "},{"type":"span","marks":["code"],"value":"HandleImpact"},{"type":"span","value":" like we've done. "}]},{"type":"heading","level":1,"children":[{"type":"span","value":"Results"}]},{"type":"paragraph","children":[{"type":"span","value":"We should now correctly slide along any walls:"}]},{"item":"55423365","type":"block"},{"type":"paragraph","children":[{"type":"span","value":"Interestingly, since "},{"type":"span","marks":["code"],"value":"SlideAlongSurface"},{"type":"span","value":" is not restricted to the horizontal plane we actually slide up slopes as well: "}]},{"item":"55423366","type":"block"},{"type":"paragraph","children":[{"type":"span","value":"However we don't slide down as no collision is happening and we aren't applying gravity (which is what we will take a look at in the next part!)."}]},{"type":"paragraph","children":[{"type":"span","value":"Our full "},{"type":"span","marks":["code"],"value":"TickComponent"},{"type":"span","value":" function now looks like this:"}]},{"code":"void USimpleMovementComponent::TickComponent(float DeltaTime, ELevelTick TickType,\n                                             FActorComponentTickFunction* ThisTickFunction)\n{\n  Super::TickComponent(DeltaTime, TickType, ThisTickFunction);\n\n  if (ShouldSkipUpdate(DeltaTime))\n  {\n    return;\n  }\n\n  if (!PawnOwner || !UpdatedComponent)\n  {\n    return;\n  }\n  \n  // Reset velocity\n  Velocity.X = 0;\n  Velocity.Y = 0;\n\n  // Calculate force\n  const FVector& Input = ConsumeInputVector().GetClampedToMaxSize2D(1.0f);\n  const FVector DesiredInputForce = Input * MoveSpeed;\n  Velocity += DesiredInputForce;\n  const FVector MovementDelta = Velocity * DeltaTime;\n\n  // Move\n  const FRotator& Rotation = UpdatedComponent->GetComponentRotation();\n\n  FHitResult Hit;\n  SafeMoveUpdatedComponent(MovementDelta, Rotation, true, Hit);\n  \n  if (Hit.IsValidBlockingHit())\n  {\n    HandleImpact(Hit, DeltaTime, MovementDelta);\n    SlideAlongSurface(MovementDelta, 1.0f - Hit.Time, Hit.Normal, Hit, true);\n  }\n  \n  UpdateComponentVelocity();\n}","type":"code","language":"cpp"}]}},"blocks":[{"__typename":"ImageRecord","id":"55423363","image":{"responsiveImage":{"base64":"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAoHBwgHBhQPCAgLChUVFxgNGBQVDhkeFhgTFxUZGBYWFyEbHzckHx0oHRUiJTUlKC0vOjIyGSI4PTcwPCsxMi8BCgsLDg0OHRAQHDsgIhwvLy8vNTs7Oy8wLzwvNS8vLy8vLzUvLzYvOy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL//AABEIABQAGAMBIgACEQEDEQH/xAAbAAACAQUAAAAAAAAAAAAAAAAABAUBAgMGB//EACIQAAIBAgUFAAAAAAAAAAAAAAABAwIEBRMhIjEGERIyUv/EABYBAQEBAAAAAAAAAAAAAAAAAAMAAf/EABoRAAIDAQEAAAAAAAAAAAAAAAACASFBMRH/2gAMAwEAAhEDEQA/AOb1YnHC9WOWuLRyLaxSrAXPVo2iVsOmMunhsyVsyOGGfFI41ufYBq76ZzVqmA6ovllBLWcdDr4NgtYqPD1KgHpYXyRUfIAAhH//2Q==","srcSet":"https://www.datocms-assets.com/77616/1661954484-fpmfs-pt3-collision-profile.png?auto=format&dpr=0.25&max-w=600 106w,https://www.datocms-assets.com/77616/1661954484-fpmfs-pt3-collision-profile.png?auto=format&dpr=0.5&max-w=600 212w,https://www.datocms-assets.com/77616/1661954484-fpmfs-pt3-collision-profile.png?auto=format&dpr=0.75&max-w=600 318w,https://www.datocms-assets.com/77616/1661954484-fpmfs-pt3-collision-profile.png?auto=format&max-w=600 425w","webpSrcSet":"https://www.datocms-assets.com/77616/1661954484-fpmfs-pt3-collision-profile.png?auto=format&dpr=0.25&fm=webp&max-w=600 106w,https://www.datocms-assets.com/77616/1661954484-fpmfs-pt3-collision-profile.png?auto=format&dpr=0.5&fm=webp&max-w=600 212w,https://www.datocms-assets.com/77616/1661954484-fpmfs-pt3-collision-profile.png?auto=format&dpr=0.75&fm=webp&max-w=600 318w,https://www.datocms-assets.com/77616/1661954484-fpmfs-pt3-collision-profile.png?auto=format&fm=webp&max-w=600 425w","sizes":"(max-width: 425px) 100vw, 425px","src":"https://www.datocms-assets.com/77616/1661954484-fpmfs-pt3-collision-profile.png?auto=format&max-w=600","alt":null,"title":null,"width":425,"height":340,"aspectRatio":1.25}}},{"__typename":"WebmRecord","id":"55423364","video":{"title":null,"alt":null,"video":{"muxPlaybackId":"YzJL8DWsYt5qiFfkUBBfV46jwxSMMCjE"}}},{"__typename":"WebmRecord","id":"55423365","video":{"title":null,"alt":null,"video":{"muxPlaybackId":"00Nq87qgzBRE9fTlkNcbAKmogR7M7YMqS"}}},{"__typename":"WebmRecord","id":"55423366","video":{"title":null,"alt":null,"video":{"muxPlaybackId":"6JqjADmYqP7p41x01DX6qyLECXIZMounU"}}}]}},"isPreview":false},"__N_SSG":true}